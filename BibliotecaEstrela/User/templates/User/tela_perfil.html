{% extends 'base.html' %}
{% load static %}

{% block content %}
{% load crispy_forms_tags %}
    <main class="text-center" style="padding: 0 10%">
        
        <div class="row">
        <h2>Informações do Perfil</h2>
        <form method="POST" id="perfilForm">
            {% csrf_token %}
            <div class="d-flex gap-5"> <!-- Transforma tudo em 'display: flex', da um espaçamento de gap-5 do bootstrap e alinha tudo no começo da div -->
                
                <div class="card-perfil estatisticas text-align-start" style="flex:0 0 250px">
                    
                    

                    <form method="post" enctype="multipart/form-data" class="d-flex flex-column align-items-center">
                        {% csrf_token %}

                        <label for="id_imagem" class="imagem-label">
                            <div class="imagem">
                                <img id="preview" 
                                    src="{% if user.imagem %}{{ user.imagem.url }}{% else %}{% static 'img/placeholder.png' %}{% endif %}" 
                                >
                                    
                            </div>
                            {{ imagem_form.imagem }}
                        </label>

                        <button id="btn_salvar-imagem" type="submit" name="salvar_imagem" class="estilizacao" style="display: none;">Salvar Imagem</button>
                    </form>

                        
                    

                    <div class="campo_estatisticas d-flex flex-column gap-0">

                        <h2>Estatísticas</h2>

                        <div class="info-estatisticas">
                            <p>Livros reservados</p>
                        </div>

                        <div class="info-estatisticas">
                            <p>Livros devolvidos</p>
                        </div>

                        <div class="info-estatisticas">
                            <p>Avaliações</p>
                        </div>

                        <div class="info-estatisticas">
                            <p>Lista de desejos</p>
                        </div>

                    </div>

                </div>

                <div class="flex-grow-1 ms-2 d-flex flex-column gap-5"> <!-- Faz com que tudo que esteja dentro dessa div, preencha todo o tamanho. -->

                    <div class="card-perfil editar-perfil d-flex align-items-start flex-column gap-1 py-4 px-5">
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <h2>Informações do Perfil</h2>
                            <a id="abrir_modal" class="btn-modal-perfil">Deletar perfil</a>
                        </div>

                        <form method="POST" id="perfilForm" class="d-flex flex-column gap-2 w-100">
                            {% csrf_token %}

                            <div class="d-flex flex-row gap-4">
                                <div class="campo-perfil d-flex flex-column flex-grow-1">
                                    <label for="username" class="align-self-start">Nome</label>

                                    <div class="input-wrapper d-flex">
                                        {{ form.username }}
                                        <button type="button" class="editarBtn">✏️editar</button>
                                    </div>

                                </div>
                            

                                <div class="campo-perfil d-flex flex-column flex-grow-1">
                                    <label for="new_password" class="align-self-start">Senha</label>

                                    <div class="input-wrapper d-flex">
                                        {{ form.new_password }}
                                        <button type="button" class="editarBtn">✏️editar</button>
                                    </div>

                                </div>
                            </div>

                            <div class="d-flex flex-row gap-4">
                                <div class="campo-perfil d-flex flex-column flex-grow-1">
                                    <label for="email" class="align-self-start">Email</label>

                                    <div class="input-wrapper d-flex">
                                        {{ form.email }}
                                        <button type="button" class="editarBtn">✏️editar</button>
                                    </div>

                                </div>

                                <div class="campo-perfil d-flex flex-column flex-grow-1">
                                    <label for="telefone" class="align-self-start">Telefone</label>

                                    <div class="input-wrapper d-flex">
                                        {{ form.telefone }}
                                        <button type="button" class="editarBtn">✏️editar</button>
                                    </div>

                                </div>
                            </div>

                            <div class="campo-perfil d-flex flex-column flex-grow-1">
                                <label for="cpf" class="align-self-start">CPF</label>
                                <div class="input-wrapper d-flex" id="animacao-cpf">
                                    {{ form.cpf }}
                                    <p class="aviso-cpf exclamacao" id="exclamacao">!!!</p>
                                    <p class="aviso-cpf" id="aviso-cpf">Não é possível editar esta informação, caso necessário, entre em contato com o bibliotecário.</p>
                                    <!-- <button type="button" class="editarBtn">✏️editar</button> -->
                                </div>
                            </div>

                            <button type="submit" id="salvarBtn" name="salvar_dados" style="display:none;" class="estilizacao">Salvar Alterações</button>
                        </form>
                    </div>

                    <div class="card-perfil d-flex align-items-start py-4 px-5">
                        <h2>Notificações</h2>
                    </div>
                    
                    <div class="card-perfil d-flex flex-column align-items-start py-4 px-5">
                        <h2>Livros Reservados</h2>

                        <div class="d-flex flex-row w-100 gap-4">
                            {% for reserva in reservas %}

                            <div class="card-livros col-12 col-md-6 col-lg-3 mb-4">
                                <div class="card h-100 book-item shadow-sm">
                                    {% if not reserva.id_livro.imagem %}
                                        <img src="https://via.placeholder.com/300x450?text=Sem+Capa" class="card-img-top" style="height: 350px; object-fit: cover;" alt="Sem capa">
                                    {% else %}
                                    <div>
                                        <img src="{{ reserva.id_livro.imagem.url }}" class="card-img-top" style="height: 350px; object-fit: cover;" alt="{{ livro.nome }}">
                                    </div>
                                    {% endif %}
                                    <div class="card-body d-flex flex-column text-center">
                                        <h6 class="card-title fw-bold">{{ reserva.id_livro.nome }}</h6>
                                        <p class="card-text text-muted small mt-auto">{{ reserva.id_livro.autor }}</p>
                                        {{ reserva.data_reserva }}
                                    </div>
                                </div>
                            </div>

                            {% endfor %}
                        </div>
                    </div>
                    

                </div>
            </div>
        </div>

    <script>
        document.getElementById('id_imagem').addEventListener('change', function(event) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('preview').src = e.target.result;
            }
            reader.readAsDataURL(event.target.files[0]);

            document.getElementById('btn_salvar-imagem').style.display = 'flex';
        });

        document.getElementById('btn_salvar-imagem').onclick = style.display = 'none'
    </script>

    </main>
        </main>
    </div>

    {% include 'User/modal_deletar.html' %}

    <script>
        document.getElementById('abrir_modal').onclick = () => {
            document.getElementById('modal_deletar').style.display = 'block';
        };
        document.getElementById('fechar').onclick = () => {
            document.getElementById('modal_deletar').style.display = 'none';
        };
    </script>

{% endblock content %}